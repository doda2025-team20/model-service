name: Train and Release Model

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  train-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(python scripts/manage_version.py pyproject.toml --get)
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Train model
        run: |
          mkdir -p output
          python src/text_preprocessing.py
          python src/text_classification.py

      - name: Package model artifacts
        run: |
          zip -r model.zip output/

          cat <<EOF > metadata.json
          {
            "model_version": "${{ steps.version.outputs.version }}",
            "git_commit": "${GITHUB_SHA}",
            "trained_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF

          zip model-${{ steps.version.outputs.version }}.zip model.zip metadata.json

      - name: Create or overwrite GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="model-${{ steps.version.outputs.version }}"

          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" \
              --title "Model $TAG" \
              --notes "Automatically trained model for service version ${{ steps.version.outputs.version }}" \
              --prerelease
          fi

          gh release upload "$TAG" \
            model-${{ steps.version.outputs.version }}.zip \
            --clobber
